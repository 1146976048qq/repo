From 92925714607f565a1fe9088f5ecd1a0727f317a8 Mon Sep 17 00:00:00 2001
From: axionl <i@axionl.me>
Date: Sun, 19 May 2019 01:24:12 +0800
Subject: [PATCH] Revert "track applets mouse click events differently"

This reverts commit 927c518a6d2242c4235116670eaede277b75deb6.
---
 .../package/contents/ui/applet/AppletItem.qml | 42 +++++++++----------
 1 file changed, 21 insertions(+), 21 deletions(-)

diff --git a/containment/package/contents/ui/applet/AppletItem.qml b/containment/package/contents/ui/applet/AppletItem.qml
index 559c04be..2f5cd404 100644
--- a/containment/package/contents/ui/applet/AppletItem.qml
+++ b/containment/package/contents/ui/applet/AppletItem.qml
@@ -115,7 +115,6 @@ Item {
                                                                                            ||((index === layoutsContainer.mainLayout.beginIndex+layoutsContainer.mainLayout.count-2)&&(layoutsContainer.mainLayout.count>2))
                                                                                            ||((index === layoutsContainer.endLayout.beginIndex+layoutsContainer.endLayout.count-1)&&(layoutsContainer.endLayout.count>1)))
 
-    readonly property bool acceptMouseEvents: applet && !isLattePlasmoid && !originalAppletBehavior && !appletItem.isSeparator && !communicator.parabolicEffectLocked
     readonly property bool originalAppletBehavior: ((root.zoomFactor === 1 || !canBeHovered) && !root.titleTooltips) || lockZoom
     readonly property bool isSquare: communicator.overlayLatteIconIsActive
 
@@ -154,7 +153,7 @@ Item {
     property Item communicatorAlias: communicator
     property Item wrapperAlias: wrapper
 
-    property bool containsMouse: appletMouseArea.containsMouse /*|| appletMouseAreaBottom.containsMouse*/
+    property bool containsMouse: appletMouseArea.containsMouse || appletMouseAreaBottom.containsMouse
     property bool pressed: viewSignalsConnector.pressed || clickedAnimation.running
 
 
@@ -211,18 +210,8 @@ Item {
         //unfortunately for other applets there is no other way to activate them yet
         //for example the icon-only applets
         var choords = mapToItem(appletItem.appletWrapper, mouse.x, mouse.y);
-
-        var wrapperContainsMouse = choords.x>=0 && choords.y>=0 && choords.x<appletItem.appletWrapper.width && choords.y<appletItem.appletWrapper.height;
-        var appletItemContainsMouse = mouse.x>=0 && mouse.y>=0 && mouse.x<width && mouse.y<height;
-
-        //console.log(" APPLET :: " + mouse.x +  " _ " + mouse.y);
-        //console.log(" WRAPPER :: " + choords.x + " _ " + choords.y);
-
-        if (appletItemContainsMouse && !wrapperContainsMouse) {
-            //console.log("PASSED");
+        if (choords.x<0 || choords.y<0 || choords.x>=appletItem.appletWrapper.width || choords.y>=appletItem.appletWrapper.height) {
             latteView.toggleAppletExpanded(applet.id);
-        } else {
-            //console.log("REJECTED");
         }
     }
 
@@ -525,9 +514,7 @@ Item {
             if (appletItem.containsPos(pos)) {
                 viewSignalsConnector.pressed = true;
                 var local = appletItem.mapFromItem(root, pos.x, pos.y);
-
                 appletItem.mousePressed(local.x, local.y, button);
-                appletItem.activateAppletForNeutralAreas(local);
             }
         }
 
@@ -580,9 +567,6 @@ Item {
         border.color: "green"
         border.width: 1
     }*/
-
-
-  /* DEPRECATED in favor of VIEW::MouseSignalsTracking
     MouseArea{
         id: appletMouseAreaBottom
         anchors.fill: parent
@@ -597,7 +581,7 @@ Item {
         onReleased: {
             mouse.accepted = false;
         }
-    }*/
+    }
 
     //! Main Applet Shown Area
     Flow{
@@ -747,16 +731,20 @@ Item {
         anchors.fill: parent
         enabled: visible
         hoverEnabled: latteApplet ? false : true
-        propagateComposedEvents: true
+       // propagateComposedEvents: true
 
         //! a way must be found in order for this be enabled
         //! only to support springloading for plasma 5.10
         //! also on this is based the tooltips behavior by enabling it
         //! plasma tooltips are disabled
-        visible: acceptMouseEvents
+        visible: applet && !isLattePlasmoid && !originalAppletBehavior && !appletItem.isSeparator && !communicator.parabolicEffectLocked
 
         property bool blockWheel: false
 
+        onClicked: {
+            mouse.accepted = false;
+        }
+
         onEntered: {
             if (containsMouse && !originalAppletBehavior && !communicator.parabolicEffectLocked && appletItem.canBeHovered){
                 root.stopCheckRestoreZoomTimer();
@@ -857,6 +845,18 @@ Item {
             mouse.accepted = false;
         }
 
+        onPressed: {
+            appletItem.activateAppletForNeutralAreas(mouse);
+
+            //! this is needed for some applets is order to be activated/deactivated correctly
+            //! such case is the "Application Menu". (bug #928)
+            mouse.accepted = false;
+        }
+
+        onReleased: {
+            mouse.accepted = false;
+        }
+
         onWheel: {
             if (isSeparator || !root.mouseWheelActions || blockWheel
                     || (root.latteViewIsHidden || root.inSlidingIn || root.inSlidingOut)){
-- 
2.21.0

