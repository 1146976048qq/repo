From fe2e415bdcdfbf7c20ca89775b4a19fe8d0cc2e3 Mon Sep 17 00:00:00 2001
From: Peter Cai <peter@typeblog.net>
Date: Thu, 24 Sep 2020 19:45:18 +0800
Subject: [PATCH] correct position of QScreen geometry on HiDPI multi-headed
 setup

---
 src/utils/screengrabber.cpp           | 5 ++++-
 src/widgets/capture/capturewidget.cpp | 6 ++++++
 2 files changed, 10 insertions(+), 1 deletion(-)

diff --git a/src/utils/screengrabber.cpp b/src/utils/screengrabber.cpp
index c2a9ae6..e7c4e0a 100644
--- a/src/utils/screengrabber.cpp
+++ b/src/utils/screengrabber.cpp
@@ -89,7 +89,10 @@ ScreenGrabber::grabEntireDesktop(bool& ok)
 
   QRect geometry;
   for (QScreen* const screen : QGuiApplication::screens()) {
-    geometry = geometry.united(screen->geometry());
+    QRect scrRect = screen->geometry();
+    scrRect.moveTo(scrRect.x() / screen->devicePixelRatio(),
+                   scrRect.y() / screen->devicePixelRatio());
+    geometry = geometry.united(scrRect);
   }
 
   QPixmap p(
diff --git a/src/widgets/capture/capturewidget.cpp b/src/widgets/capture/capturewidget.cpp
index b85883a..c97093f 100644
--- a/src/widgets/capture/capturewidget.cpp
+++ b/src/widgets/capture/capturewidget.cpp
@@ -125,6 +125,8 @@ CaptureWidget::CaptureWidget(const uint id,
   if (m_context.fullscreen) {
     for (QScreen* const screen : QGuiApplication::screens()) {
       QRect r = screen->geometry();
+      r.moveTo(r.x() / screen->devicePixelRatio(),
+               r.y() / screen->devicePixelRatio());
 #ifdef Q_OS_WIN
       r.moveTo(r.topLeft() - topLeft);
 #endif
@@ -608,6 +610,10 @@ CaptureWidget::initPanel()
   QRect panelRect = rect();
   if (m_context.fullscreen) {
     panelRect = QGuiApplication::primaryScreen()->geometry();
+    auto devicePixelRatio =
+      QGuiApplication::primaryScreen()->devicePixelRatio();
+    panelRect.moveTo(panelRect.x() / devicePixelRatio,
+                     panelRect.y() / devicePixelRatio);
   }
 
   ConfigHandler config;
-- 
2.28.0
