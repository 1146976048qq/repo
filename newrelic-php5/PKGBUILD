# Maintainer: Felix Yan <felixonmars@gmail.com>
# Contributor: Vinh Nguyen <kurei [at] axcoto.com>

pkgname=newrelic-php5
pkgver=4.15.0.74
_libver=20131226
pkgrel=1
pkgdesc="NewRelic PHP"
arch=('i686' 'x86_64')
url="http://newrelic.com/"
license=('non-free')
depends=('glibc' 'php')
backup=('etc/php/conf.d/newrelic.ini')
install=.install
source=("https://download.newrelic.com/php_agent/release/$pkgname"-"$pkgver"-"linux.tar.gz"
        "newrelic-daemon.service"
        ".install")
md5sums=('99f9a276859d266432efc97059a6de71'
         '4fc78347663adcb32ed28eddb546619c'
         'd3f7bb7fc0d84dff40d294384a32ddd3')

build() {
  cd "$srcdir/$pkgname-$pkgver-linux"
}

package() {
  cd "$srcdir/$pkgname-$pkgver-linux" 

  mkdir -p $pkgdir/usr/bin/ \
            $pkgdir/usr/lib/php/modules/ \
            $pkgdir/usr/share/doc/newrelic-php5/ \
            $pkgdir/usr/lib/systemd/system/ \
            $pkgdir/etc/php/conf.d/;

  if [ $CARCH == i686 ]; then
    # Binary Daemon
    install -v -Dm755 ./daemon/newrelic-daemon.x86 $pkgdir/usr/bin/newrelic-daemon
    # PHP extension
    install -v -Dm755 ./agent/x86/newrelic-$_libver-zts.so $pkgdir/usr/lib/php/modules/newrelic-$_libver-zts.so
    install -v -Dm755 ./agent/x86/newrelic-$_libver.so $pkgdir/usr/lib/php/modules/newrelic-$_libver.so
  else
    # Binary Daemon
    install -v -Dm755 ./daemon/newrelic-daemon.x64 $pkgdir/usr/bin/newrelic-daemon
    # PHP extension
    install -v -Dm755 ./agent/x64/newrelic-$_libver-zts.so $pkgdir/usr/lib/php/modules/newrelic-$_libver-zts.so
    install -v -Dm755 ./agent/x64/newrelic-$_libver.so $pkgdir/usr/lib/php/modules/newrelic-$_libver.so
  fi

  install -v -Dm644 ./README ./LICENSE $pkgdir/usr/share/doc/newrelic-php5/
  
  install -v -Dm644 ./scripts/newrelic.ini.template $pkgdir/etc/php/conf.d/newrelic.ini
  install -v -Dm644 ./scripts/newrelic.ini.template $pkgdir/etc/php/conf.d/newrelic.ini.template
  
  install -v -Dm644 ../newrelic-daemon.service $pkgdir/usr/lib/systemd/system/
}
