From 0739fc03d617cd151fcd8292248472b8525e95ff Mon Sep 17 00:00:00 2001
From: Yichao Yu <yyc1992@gmail.com>
Date: Fri, 13 Jan 2017 21:46:09 -0500
Subject: [PATCH] Fix compilation on LLVM svn

Ref https://github.com/llvm-mirror/llvm/commit/4cdbd20e4e0269fd874b5a3f7d0f9e280b86cd9e
Ref https://github.com/llvm-mirror/llvm/commit/faaafe58c6aaa5c523892eaf5b65fc642097513c
---
 src/codegen.cpp    | 3 +++
 src/intrinsics.cpp | 4 ++++
 2 files changed, 7 insertions(+)

diff --git a/src/codegen.cpp b/src/codegen.cpp
index b8e114e..570f870 100644
--- a/src/codegen.cpp
+++ b/src/codegen.cpp
@@ -4422,6 +4422,9 @@ static std::unique_ptr<Module> emit_function(
         // TODO: Fix when moving to new LLVM version
         #if JL_LLVM_VERSION < 30400
         dbuilder.createCompileUnit(0x01, filename, ".", "julia", true, "", 0);
+        #elif JL_LLVM_VERSION >= 40000
+        DIFile *difile = dbuilder.createFile(filename, ".");
+        DICompileUnit *CU = dbuilder.createCompileUnit(0x01, difile, "julia", true, "", 0);
         #elif JL_LLVM_VERSION >= 30700
         DICompileUnit *CU = dbuilder.createCompileUnit(0x01, filename, ".", "julia", true, "", 0);
         #else
diff --git a/src/intrinsics.cpp b/src/intrinsics.cpp
index 277b6b5..ff1fc3c 100644
--- a/src/intrinsics.cpp
+++ b/src/intrinsics.cpp
@@ -154,7 +154,11 @@ static Value *uint_cnvt(Type *to, Value *x)
     return builder.CreateZExt(x, to);
 }
 
+#if JL_LLVM_VERSION >= 40000
+#define LLVM_FP(a,b) APFloat(a(),b)
+#else
 #define LLVM_FP(a,b) APFloat(a,b)
+#endif
 static Constant *julia_const_to_llvm(void *ptr, jl_value_t *bt)
 {
     // assume `jl_isbits(bt)`.
-- 
2.10.2

